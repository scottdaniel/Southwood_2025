---
title: |
  ![](CHOPMC_logo.pdf){width=5in}  
  "Laurel Redding / CHOPMC-373 / Horse Project / Shotgun"
author: "Scott G. Daniel, Ph.D."
date: \today
output: 
    pdf_document:
        keep_tex: false
        toc: true
        toc_depth: 4
---

```{r setup, echo=FALSE, message=FALSE}
library(knitr)
opts_chunk$set(
  tidy=FALSE,
  cache=FALSE,
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  dpi=100,
  fig.width=5,
  fig.height=3,
  fig.align = "center",
  out.width = "100%"
  )

library(tidyverse)
library(qiimer)
library(vegan)
library(ape)
library(usedist)
library(here)

## Visualization packages
library(pander)
library(gt)

library(pheatbuilder)
library(ggbeeswarm)
library(ggsci)
library(viridis)
library(wesanderson)
library(RColorBrewer)

# stats packages
library(adonisplus)
library(nlme)
library(emmeans) # for lmer post-hoc tests
library(broom)

library(pwr) # for power analysis

library(glue)
library(magrittr)

panderOptions("knitr.auto.asis", FALSE)

source(here::here("Scripts","Functions","common_functions.R"))
source(here::here("Scripts","Functions","for_functional_analysis.R"))
source(here::here("Scripts","Functions","scott_daniel_useful_R_functions.R"))
```

```{r load}

load(file = here("Data", "preamble_data.RData"))

```

```{r}
table_export <- table_iterator()
```

```{r add in clinical data}

clin_md <- read_csv(here("Data", "ClinicalDataFinal.csv")) %>%
  select(-study_group)

s2 <- s %>%
  left_join(clin_md, join_by(subject_id)) %>%
  mutate(timepoint = ifelse(study_day > 0, "Discharge", "Admit"))

# no NA's, we are good

s2 %<>%
  filter(host_species %in% c("Horse")) %>%
  mutate(Sex = ifelse(Sex %in% "G", "M", Sex)) %>%
  mutate(Age = as.numeric(Age)) %>%
  filter(!str_detect(Name, "EXCLUDE"))

```

# Run overview

## Host vs. non-host reads per sample

```{r}
s2 %>%
  mutate(`Percent host reads` = round(100 * host / (host + nonhost),2)) %>%
  arrange(desc(`Percent host reads`)) %>%
  select(
    SampleID,
    `Host reads` = host,
    `Non-host reads` = nonhost,
    `Percent host reads`) %>%
  write_csv(here("Figures", "host_read_removal_table.csv"))
```


## Taxonomic heatmap

```{r}
prop_cut <- 0.01
```

Taxonomic assignments were performed using the Kraken program.

Heatmap charts were generated from the taxonomic assignments. Each column represents one sample and each row represents one taxon (typically a species). Ranks are included in the plot if the taxon is present in `r 100*prop_cut`% mean abundance in at least one sample type.

The chart is colored white if species were not observed in the sample, dark blue if species were observed at very low abundance.  This allows the reader to quickly survey species presence/absence.  Abundance values exceeding 40% are colored red, indicating an extremely dominant species.


```{r fig.width=20, fig.height=10}
s_toPlot <- s2 %>%
  filter(host_species %in% c("Horse") | is.na(host_species)) %>%
  filter(kraken_counts > 0 | !is.na(kraken_counts)) %>%
  select(SampleID, SampleType, timepoint, study_group) %>%
  arrange(timepoint, study_group, SampleType) %>%
  droplevels()

# select taxa with mean relative abundance of 1% in at least one sample type
select_taxa <- summed_props %>%
  as.data.frame() %>% 
  rownames_to_column("Taxa") %>% 
  pivot_longer(-Taxa, names_to="SampleID", values_to="props") %>%
  right_join(s_toPlot, by="SampleID")  %>%
  group_by(SampleType, Taxa) %>%
  mutate(mean_prop = mean(props)) %>%
  ungroup() %>%
  group_by(Taxa) %>%
  mutate(mean_prop = max(mean_prop)) %>%
  ungroup() %>%
  filter(mean_prop > prop_cut) %>%
  pull(Taxa) %>%
  as.character() %>%
  unique()

props_toPlot <- summed_props[select_taxa, s_toPlot$SampleID]
props_toPlot %>%
  pheat() %>%
  pheat_color_saturated() %>%
  pheat_cluster_rows() %>%
  pheat_annotate_cols(s_toPlot) %>%
  pheat_display_cols(gaps = factor_gaps(s_toPlot$SampleType)) 
```

```{r}
props_toPlot %>%
  pheat() %>%
  pheat_color_saturated() %>%
  pheat_cluster_rows() %>%
  pheat_annotate_cols(s_toPlot) %>%
  pheat_display_cols(gaps = factor_gaps(s_toPlot$SampleType)) %>%
  pheat_save(filename = here("Output", "heatmap_study_groups.pdf"))
```

# Total reads

```{r, results='asis'}

my_summary_stats <- preprocess %>%
  right_join(s_toPlot, join_by(SampleID)) %>%
  group_by(SampleType) %>%
  summarise(total_raw_reads = sum(input), total_post_QC = sum(nonhost))

my_summary_stats %>%
  pander(split.table = Inf, big.mark = ',')

```

# 72hr vs 24hr and Admit vs. Discharge

```{r colors, results='asis'}
## Subset the metadata file to only keep the samples you would like to test on
s_toTest <- s2 %>%
  filter(host_species %in% c("Horse")) %>%
  filter(Keep) %>%
  filter(!isControl) %>%
  mutate(study_group = fct_relevel(study_group, "24h", "72h")) %>%
  mutate(timepoint = fct_relevel(timepoint, "Admit")) %>%
  mutate(time_study = paste0(timepoint, study_group)) %>%
  mutate(time_study = fct_relevel(time_study, "Admit24h", "Admit72h", "AdmitMed", "Discharge24h", "Discharge72h")) %>%
  droplevels()

## Set colors for each factor ahead of time so they are consistent through the report.
ann_colors = list(
  time_study = setNames(brewer.pal(length(levels(s_toTest$time_study)), "Set3"), levels(s_toTest$time_study)))
ann_colors = list(time_study = c(Admit24h = "#8DD3C7", Admit72h = "#FFFFB3", 
AdmitMed = "#BEBADA", Discharge24h = "#FB8072", Discharge72h = "#80B1D3", 
DischargeMed = "#FDB462"),
timepoint = c(Admit = "#9677DF", Discharge = "#EABE94"),
study_group = c(`24h` = "#DAC36A", `72h` = "#5C72CE", Med = "#D2D9E8"),
SampleType = c("#A6CEE3", "#1F78B4", "#B2DF8A"))

#for colorblind-safe colors, use 
# qualpalr::autopal()

## Change this to be the breakdown of whatever variable the collaborator is interested in
addmargins(table(s_toTest$timepoint, s_toTest$study_group, useNA = "ifany")) %>%
  pander(split.table=Inf)
```

## Differential abundance

Taxa abundances that had zero values were replaced with 1/2 the minimum value out of all samples for a given taxa. Figure shows all the bacteria that have a mean relative abundance of >1% across samples. Only these bacteria have been tested in this report.

```{r}

summed_props_long <- summed_props %>%
  as.data.frame() %>%
  rownames_to_column(var = "Taxa") %>%
  pivot_longer(-Taxa, names_to = "SampleID", values_to = "props") %>%
  mutate(Taxa = str_trim(Taxa)) %>%
  group_by(Taxa) %>%
  filter(sum(props) > 0) %>%
  mutate(taxa_min = min(props[props > 0])) %>%
  mutate(props = ifelse(props == 0, taxa_min/2, props)) %>%
  ungroup() %>%
  mutate(props = if_else(props >= 1, 0.999999, props)) %>% #this accounts for samples that are entirely one taxa
  mutate(props_log2 = log2(props))

props_toTest <- summed_props_long %>%
  group_by(Taxa) %>%
  mutate(perc_present = mean(props > 0)) %>%
  mutate(mean_prop = mean(props)) %>%
  ungroup() %>%
  filter(mean_prop > 0.01) %>%
  filter(str_detect(Taxa, "crAssphage|Vibrio", negate = T))
```

### Boxplot

```{r fig.height=12, fig.width=8}
props_toTest %>%
  right_join(s_toTest, by = "SampleID") %>%
  mutate(Taxa = reorder(Taxa, -props)) %>%
  mutate(Taxa = fct_relabel(Taxa, function(x) gsub(" ", "\n", x))) %>%
  ggplot(aes(x=time_study, y=props, color=time_study)) +
  geom_boxplot(outlier.alpha=0) +
  geom_quasirandom(dodge.width = 0.75) +
  facet_wrap(~Taxa, scales="free", ncol = 4) +
  scale_color_manual(values=ann_colors$time_study) +
  scale_y_continuous(trans = "log10") +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle=90, hjust=1, vjust=0.5),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    legend.position = "bottom"
  ) +
  #guides(color="none") +
  labs(
    y="Relative abundance",
    x="",
    color="Time"
  )

ggsave(here("Output", "taxa_changed_horses_boxplot.pdf"), height = 12, width = 8)

```

### Tests

Linear mixed-effect models were used to estimate the change in relative abundance of selected taxa between study groups. The relative abundances were log2 transformed. subject_id was included as a random effect to account for repeated measurements. Multiple tests were adjusted for false discovery rate using Benjamini-Hochberg method. Only the terms with p<0.05 are shown in the table below. Age and sex included as covariates.


```{r, results='asis'}

summaries_df <- run_lmer_on_props(factor_to_test = "Taxa", props_toTest = props_toTest, s_toTest = s_toTest, form1 = "props_log2 ~ Age + Sex + time_study", rep_mes_label = "subject_id", p_cutoff = 0.05) %>%
  mutate(term = str_remove(term, "time_study"))

table_export(summaries_df, "Taxonomic_table_export")

summaries_df %>%
  filter(p.value < 0.5) %>%
  #select(-term) %>%
  pander(split.table=Inf, digits=2, emphasize.strong.rows = which(.$fdr<=0.05), caption = "Reference level for TimeXStudy_group is Admit24h")

```

### Additional graphs

Graph with just those that are significantly changing in the Discharge group:

```{r fig.height=8, fig.width=8}
props_toTest %>%
  filter(Taxa %in% (summaries_df %>% filter(str_detect(term, "Discharge")) %>% pull(Taxa))) %>%
  right_join(s_toTest, by = "SampleID") %>%
  mutate(Taxa = reorder(Taxa, -props)) %>%
  mutate(Taxa = fct_relabel(Taxa, function(x) gsub(" ", "\n", x))) %>%
  ggplot(aes(x=time_study, y=props, color=time_study)) +
  geom_boxplot(outlier.alpha=0) +
  geom_quasirandom(dodge.width = 0.75) +
  facet_wrap(~Taxa, scales="free", ncol = 4) +
  scale_color_manual(values=ann_colors$time_study) +
  scale_y_continuous(trans = "log10") +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle=90, hjust=1, vjust=0.5),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    legend.position = "bottom"
  ) +
  #guides(color=) +
  labs(
    y="Relative abundance",
    x="",
    color="Time"
  )

ggsave(here("Output", "taxa_changed_pvalueless0.05_boxplot.pdf"), height = 3, width = 6.25)
```

## Beta diversity

Here, we use Bray-Curtis and Jaccard distances to compare the species composition of the samples to each other.

The plots below show the distance between each pair of samples in a single 2D plot.  It is not possible to plot the distances exactly on paper, so we have used a method of ordination called Principal Coordinates Analysis to select the best coordinate system for display.  The percentage of total variance captured along each axis is displayed on the chart.

/newpage

```{r fig.height=3, fig.width=3}
s_toTest %>%
  pcoaplus(bc) %>%
  plot(color=time_study) +
    scale_color_manual(values=ann_colors$time_study) +
    theme_bw() +
    theme(
      axis.text=element_blank(),
      axis.ticks=element_blank(),
      panel.grid = element_blank(), 
      aspect.ratio = 1,
      strip.background = element_blank()
    ) + 
    labs(title="Bray-Curtis",
    color="")

s_toTest %>%
  pcoaplus(jd) %>%
  plot(color=time_study) +
    scale_color_manual(values=ann_colors$time_study) +
    theme_bw() +
    theme(
      axis.text=element_blank(),
      axis.ticks=element_blank(),
      panel.grid = element_blank(), 
      aspect.ratio = 1,
      strip.background = element_blank()
    ) + 
    labs(title="Jaccard",
    color="")

```

\newpage

### NMDS

Non-metric dimensional scaling (NMDS) because reviewer #3 asked.

```{r}

bc_sub <- dist_subset(bc, s_toTest$SampleID)

bc_NMDS <-
  metaMDS(bc_sub,
          distance = "bray",
          k = 3,
          maxit = 999, 
          trymax = 500,
          wascores = TRUE)

```

```{r}
# Shepards test/goodness of fit
goodness(bc_NMDS) # Produces a results of test statistics for goodness of fit for each point

stressplot(bc_NMDS) # Produces a Shepards diagram
```

Let's plot this with ggplot.

```{r}

data.scores <- as.data.frame(scores(bc_NMDS))  #Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores$SampleID <- rownames(data.scores)  # create a column of site names, from the rownames of data.scores
data.scores %<>%
  left_join(s_toTest %>% select(SampleID, timepoint), join_by(SampleID))
# head(data.scores)  #look at the data

ggplot() + 
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,shape=NULL,colour=timepoint),size=3) + # add the point markers
  scale_colour_manual(values=ann_colors$timepoint) +
  coord_equal() +
  theme_bw() +
  labs(colour = "Timepoint")

ggsave(here("Figures", "NMDS_taxa_admit_vs_discharge.pdf"), useDingbats = F, height = 4, width = 5)

```

Alternate form.

```{r}

ggplot() + 
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,shape=NULL,colour=timepoint),size=3) + # add the point markers
  scale_colour_manual(values=ann_colors$timepoint) +
  coord_equal() +
  theme_bw() +
  labs(colour = "Timepoint") + 
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank())

```

With hulls.

```{r}

grp.a <- data.scores[data.scores$timepoint == "Admit", ][chull(data.scores[data.scores$timepoint == 
    "Admit", c("NMDS1", "NMDS2")]), ]  # hull values for grp A
grp.b <- data.scores[data.scores$timepoint == "Discharge", ][chull(data.scores[data.scores$timepoint == 
    "Discharge", c("NMDS1", "NMDS2")]), ]  # hull values for grp B

hull.data <- rbind(grp.a, grp.b)  #combine grp.a and grp.b
# head(hull.data)

```

```{r}

ggplot() + 
  geom_polygon(data=hull.data,aes(x=NMDS1,y=NMDS2,fill=timepoint,group=timepoint),alpha=0.30) + # add the convex hulls
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,shape=NULL,colour=timepoint),size=3) + # add the point markers
  scale_colour_manual(values=ann_colors$timepoint) +
  scale_fill_manual(values = ann_colors$timepoint) +
  coord_equal() +
  theme_bw() +
  labs(colour = "Timepoint", fill = "Timepoint") + 
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank())

ggsave(here("Figures", "NMDS_taxa_admit_vs_discharge_hull_plot.pdf"), useDingbats = F, height = 4, width = 5)

```

### PERMANOVA

PERMANOVA test on Bray-Curtis and Jaccard distances to test if the centroids of the study groups can be distinguished from each other. subject_id was included as a random effect to account for repeated measurements.

```{r message=FALSE, warning=FALSE, results='asis'}

summaries_df <- rbind(
  s_toTest %>%
    do(adonisplus(
      ., distmat = bc, formula = distmat ~ Age + Sex + time_study,
      sample_id_var = SampleID, rep_meas_var = subject_id,
      shuffle = c(study_group = "between", timepoint = "within"), permutations=perm)) %>%
    mutate(metric = "Bray-Curtis"),
  
  s_toTest %>%
    do(adonisplus(
      ., distmat = jd, formula = distmat ~ Age + Sex + time_study,
      sample_id_var = SampleID, rep_meas_var = subject_id,
      shuffle = c(study_group = "between", timepoint = "within"), permutations=perm)) %>%
    mutate(metric = "Jaccard")
) %>%
  filter(!term %in% c("Residuals", "Total")) %>%
  select(-one_of(c("sumsq", "meansq"))) %>%
  select(metric, everything())

table_export(summaries_df, "Taxonomic_table_export")

summaries_df %>%
  pander(split.cells = 20, split.table=Inf, digits = 2, emphasize.strong.rows = which(.$p.value<=0.05))
```

\newpage

## Alpha diversity

Alpha diversity was assessed by the expected number of observed OTUs (out of rarefying sample size of `r format(richness_subsample_size, big.mark = ",", scientific = F)`) and Shannon index.

```{r fig.width=5, fig.height=3}
s_toTest %>%
  pivot_longer(c("Richness", "Shannon"), names_to="metric", values_to="alpha") %>%

  ggplot(aes(x=time_study, y=alpha, color=time_study)) +
    geom_boxplot(outlier.alpha=0) +
    geom_quasirandom(dodge.width = 0.75) +
    facet_grid(metric~., scales = "free") +
    scale_color_manual(values=ann_colors$time_study) +
    theme_bw() +
    theme(
      axis.text.x=element_text(angle=90, hjust=1, vjust=0.5),
      strip.background = element_blank(),
      panel.grid=element_blank()
    ) +
    #guides(color="none") +
    labs(
    x="",y="Alpha diversity value", color = "Study group"
    )

ggsave(here("Output", "alpha_diversity_taxa_horses.pdf"), height = 2.5, width = 4)

```

\newpage

### Tests

Linear mixed-effect models were used to estimate the difference between study groups. subject_id was included as a random effect to account for repeated measurements.

```{r, results='asis'}
summaries_df <- s_toTest %>%
  pivot_longer(c("Richness", "Shannon"), names_to="metric", values_to="alpha") %>%
  
  group_by(metric) %>%
  do(tidy_lmer(nlme::lme(alpha ~ Age + Sex + time_study, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(alpha ~ study_group * timepoint, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  #do(tidy(lm(alpha ~ study_group, data=.))) %>%
  ungroup() %>%
  filter(!grepl("Intercept", term)) %>%
  mutate(term = str_remove(term, "time_study"))

table_export(summaries_df, "Taxonomic_table_export")

summaries_df %>%
  mutate(term = str_remove(term, "study_group")) %>%
  mutate(term = str_remove(term, "timepoint")) %>%
  pander(split.cells = 20, split.table=Inf, digits = 2, emphasize.strong.rows = which(.$p.value<=0.05), caption = "Reference level for TimeXStudy_group is Admit24h")

```

# Phylum level analysis

## Stacked bar plot

```{r}

phylum_summed_props_long <- summed_props_p %>%
  as.data.frame() %>%
  rownames_to_column(var = "Taxa") %>%
  pivot_longer(-Taxa, names_to = "SampleID", values_to = "props") %>%
  mutate(Taxa = str_trim(Taxa)) %>%
  fix_zeros_v2(props) %>%
  mutate(props_log2 = log(props/(1-props))) %>%
  select(SampleID, Taxa, props, props_log2) %>%
  filter(str_detect(Taxa, "Bacteria")) %>% #getting only Bacteria phylum
  mutate(Taxa = str_remove(Taxa, "^\\w+ ")) %>% #getting just the phylum
  mutate(Taxa = if_else(Taxa %in% "Bacteria", "Unclassified Bacteria", Taxa))

top_phylum <- phylum_summed_props_long %>%
  group_by(Taxa) %>%
  summarise(mean = mean(props)) %>%
  arrange(desc(mean)) %>%
  slice(1:10) %>%
  filter(!Taxa %in% c("Cyanobacteria", "Unclassified Bacteria", "Planctomycetes")) #plant stuff and unknowns

phylum_colors <- c(setNames(ggsci::pal_npg(palette = "nrc")(length(top_phylum$Taxa)), top_phylum$Taxa), `Other phyla` = "gray")

df_toPlot <- summed_cts_p %>%
  as.data.frame() %>%
  rownames_to_column(var = "Taxa") %>%
  pivot_longer(-Taxa, names_to = "SampleID", values_to = "counts") %>%
  mutate(Taxa = str_remove(Taxa, "^\\w+ ")) %>%
  mutate(taxa_label = ifelse(Taxa %in% top_phylum$Taxa, Taxa, "Other phyla")) %>%
  right_join(s_toPlot, by = "SampleID") %>%
  group_by(timepoint, study_group, taxa_label) %>%
  summarise(counts = sum(counts), .groups = "drop")

df_toPlot %>% 
  group_by(study_group) %>%
  mutate(percentage = counts / sum(counts)) %>%
  write_excel_csv(file = here("Output", "top_phyla_abundances.csv"))

g <- df_toPlot %>%
  mutate(label = glue("{timepoint}, {study_group}")) %>%
  ggplot(aes(x = label, y = counts, fill = taxa_label)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_bw() +
  theme(strip.text.x = element_text(size = 8),
        strip.background = element_blank(),
        axis.text.x = element_text(angle=45, hjust = 1)) +
        # legend.text = element_text(face = "italic")) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Relative abundance",
    x="", fill = "Phylum") +
  scale_fill_manual(values = phylum_colors)

plot(g)

fig_name = "top_phyla.pdf"
ggsave(here("Output",fig_name), width = 5, height = 5, useDingbats = F)
print(glue("Figure saved as {fig_name}"))

```

## Differential abundance

Linear mixed-effect models were used to estimate the change in relative abundance of selected taxa between study groups. The relative abundances were log2 transformed. subject_id was included as a random effect to account for repeated measurements. Multiple tests were adjusted for false discovery rate using Benjamini-Hochberg method. Only the terms with p<0.05 are shown in the table below.


```{r, results='asis'}

props_toTest <- phylum_summed_props_long %>%
  filter(Taxa %in% top_phylum$Taxa)

summaries_df <- run_lmer_on_props(factor_to_test = "Taxa", props_toTest = props_toTest, s_toTest = s_toTest, form1 = "props_log2 ~ Age + Sex + time_study", rep_mes_label = "subject_id", p_cutoff = 1) %>%
  mutate(term = str_remove(term, "time_study"))

table_export(summaries_df, "Taxonomic_table_export")

summaries_df %>%
  filter(p.value < 0.5) %>%
  mutate(term = str_remove(term, "study_group")) %>%
  mutate(term = str_remove(term, "timepoint")) %>%
  pander(split.table=Inf, digits=2, emphasize.strong.rows = which(.$fdr<=0.05), caption = "Reference level for TimeXStudy_group is Admit24h")

```

# Genus level analysis

## Stacked bar plot

```{r}

genus_summed_props_long <- summed_props_g %>%
  as.data.frame() %>%
  rownames_to_column(var = "Taxa") %>%
  pivot_longer(-Taxa, names_to = "SampleID", values_to = "props") %>%
  mutate(Taxa = str_trim(Taxa)) %>%
  fix_zeros_v2(props) %>%
  mutate(props_log2 = log(props/(1-props))) %>%
  select(SampleID, Taxa, props, props_log2) %>%
  mutate(Taxa = if_else(Taxa %in% "Bacteria", "Unclassified Bacteria", Taxa)) %>%
  mutate(Taxa = if_else(Taxa %in% "Firmicutes", "Unclassified Firmicutes", Taxa))

top_genus <- genus_summed_props_long %>%
  group_by(Taxa) %>%
  summarise(mean = mean(props)) %>%
  arrange(desc(mean)) %>%
  slice(1:10)

genus_colors <- c(setNames(ggsci::pal_aaas(palette = "default")(length(top_genus$Taxa)), top_genus$Taxa), `Other genera` = "gray")

df_toPlot <- summed_cts_g %>%
  as.data.frame() %>%
  rownames_to_column(var = "Taxa") %>%
  pivot_longer(-Taxa, names_to = "SampleID", values_to = "counts") %>%
  mutate(Taxa = if_else(Taxa %in% "Bacteria", "Unclassified Bacteria", Taxa)) %>%
  mutate(Taxa = if_else(Taxa %in% "Firmicutes", "Unclassified Firmicutes", Taxa)) %>%
  mutate(taxa_label = ifelse(Taxa %in% top_genus$Taxa, Taxa, "Other genera")) %>%
  right_join(s_toPlot, by = "SampleID") %>%
  group_by(timepoint, study_group, taxa_label) %>%
  summarise(counts = sum(counts), .groups = "drop")

df_toPlot %>% 
  group_by(study_group) %>%
  mutate(percentage = counts / sum(counts)) %>%
  write_excel_csv(file = here("Output", "top_genera_abundances.csv"))

g <- df_toPlot %>%
  mutate(taxa_label = fct_reorder(taxa_label, counts)) %>%
  mutate(label = glue("{timepoint}, {study_group}")) %>%
  ggplot(aes(x = label, y = counts, fill = taxa_label)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_bw() +
  theme(strip.text.x = element_text(size = 8),
        strip.background = element_blank(),
        axis.text.x = element_text(angle=45, hjust = 1),
        legend.text = element_text(face = "italic")) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Relative abundance",
    x="", fill = "Genus") +
  scale_fill_manual(values = genus_colors)

plot(g)

fig_name = "top_genera.pdf"
ggsave(here("Output",fig_name), width = 6, height = 5, useDingbats = F)
print(glue("Figure saved as {fig_name}"))

```

## Differential abundance

Linear mixed-effect models were used to estimate the change in relative abundance of selected taxa between study groups. The relative abundances were log2 transformed. subject_id was included as a random effect to account for repeated measurements. Multiple tests were adjusted for false discovery rate using Benjamini-Hochberg method. Only the terms with p<0.05 are shown in the table below.

We will test the top 25 genera.


```{r, results='asis'}

top_genus <- genus_summed_props_long %>%
  group_by(Taxa) %>%
  summarise(mean = mean(props)) %>%
  arrange(desc(mean)) %>%
  slice(1:25)

props_toTest <- genus_summed_props_long %>%
  filter(Taxa %in% top_genus$Taxa)

summaries_df <- run_lmer_on_props(factor_to_test = "Taxa", props_toTest = props_toTest, s_toTest = s_toTest, form1 = "props_log2 ~ Age + Sex + time_study", rep_mes_label = "subject_id", p_cutoff = 1) %>%
  mutate(term = str_remove(term, "time_study"))

table_export(summaries_df, "Taxonomic_table_export")

summaries_df %>%
  filter(p.value < 0.05) %>%
  mutate(term = str_remove(term, "study_group")) %>%
  mutate(term = str_remove(term, "timepoint")) %>%
  pander(split.table=Inf, digits=2, emphasize.strong.rows = which(.$fdr<=0.05), caption = "Filtered by p.value < 0.05, see exported table for all results. Reference level for TimeXStudy_group is Admit24h")

```


# End of report

```{r Generate time stamped report, eval=FALSE, include=FALSE}
#notes
#neat: you can run this following command in the console to give your reports custom names (or date-stamp them)
#rmarkdown::render('ronen_stein_Report_shotgun.Rmd',output_file = paste('CEASE.report.', Sys.Date(), '.pdf', sep=''))

rstudioapi::documentSaveAll()

script_dir <- file.path("Scripts","Rmds")
output_dir <- file.path("Output")

report_fp <- here::here(script_dir, "Shotgun_taxonomic_analysis.Rmd")
output_fp <- here::here(output_dir, paste('CHOPMC-373_horses_taxonomic_analysis_', Sys.Date(), '.pdf', sep=''))

rmarkdown::render(report_fp, output_file = output_fp)

```

```{r savepoint, include=FALSE}

save.image(file = here("Data", "after_taxa_analysis.RData"))


```
